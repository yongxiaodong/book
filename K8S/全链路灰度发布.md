# 常用的发布类型

## 滚动发布

- 原理：假设A服务的v1版本部署了10个节点，轮询将这10个节点升级到v2版本  
- 优点: 易实现且节约资源
- 缺陷：在发布期间，用户的请求可能会路由到v2版本处理，也可能会路由到v1版本处理;当版本涉及数据库等、接口字段类型等变更时将会造成客户端不可预知的错误
且回滚困难


## 蓝绿发布

- 原理： 假设A服务的V1版本部署了10个节点，需要发布v2版本时，先将v2版本也不熟10个节点，然后再统一将v1版本的所有流量路由到v2版本。蓝色发布很多时候配合流量比例使用  
- 优点： 易实现，而且可以快速切换、回滚。提高发版速度
- 缺陷:  需要两倍的资源

## 按流量比例发布

原理：比如基于hash、会话、随机等策略使70%的流量到达v1版本，30%的流量到达v2版本
缺陷：


## 灰度发布(又名金丝雀发布)
- 原理： 通过流量随机百分比、header头、URI参数等用户属性的方式将流量平滑的在A/B版本上过渡，可以进行A/B 测试，让一部分用户使用灰度版本并逐渐放大流量


## 微服务全链路灰度发布系统带来的挑战
原理跟灰度发布原理一致，但是要针对整条链路实现链路灰度，比如A->B->C->D的服务调用管理中，变成A->B2->C2->D关系，有灰度版本时走灰度版本，无灰度版本的应用走正常版本
这个流量转发过程变得非常复杂


# 全链路灰度发布实现  

### 场景问题
##### 背景：
    1、放问itgod.org域名时，走正常线上版本提供服务  
    2、当User-Agnet中包含ToGray时，走灰度版本系统服务  
    3、假设有4个服务分别为A/B/C/D，正常调用关系是A->B->C->D  
    4、应用B推出了B2版本，应用D推出了D2版本，需要进行灰度发布，并进行测试  
##### 问题1： 流量标识怎么做
    用户请求中带了User-Agent: ToGray，并成功抵达了A服务，A服务在调用B服务时，B服务此时有B和B2两个版本，
    应该将来自A的请求转发到B还是B2？ 

##### 问题2： 识别了流量标识怎么路由
    应用之间的调用是通过域名的方式调用，在调用域名时，可能会进行URI rewrite等处理，而不是直接调用另外一个服务，如何控制路由？

##### 问题2： 怎么循环发布
    当所有流量都已经转发到灰度版本后，此时称为灰度完成。那么灰度版本替代了原来的正常版本，下次还要继续发布灰度版本时怎么办？  

##### 问题3： 怎么自动化
    整个过程包含一下4个大阶段, 整个过程复杂，且人工干预场景较多，如何自动化灰度流量?
    灰度环境准备： 准备应用的灰度版本，无流量路由进入  
    灰度测试流量： 一般根据设置固定的Header或则URI参数来路由  
    灰度用户级流量： 根据用户属性或随机 进行百分比流量操控  
    灰度完成：  灰度版本彻底变更为线上版本，回收老版本，将此版本做为下一次灰度的老版本使用  

##### 问题4: 怎么为更复杂的版本定制流控
    如何支持更多的灰度版本？比如在灰度测试流量部分，B服务同时有B2和B3多个版本
